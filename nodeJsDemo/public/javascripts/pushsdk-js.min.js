!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.PushSDK=e()}(this,function(){"use strict";var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function o(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function i(i,s,c,a){return new(c||(c=Promise))(function(t,e){function n(t){try{o(a.next(t))}catch(t){e(t)}}function r(t){try{o(a.throw(t))}catch(t){e(t)}}function o(e){e.done?t(e.value):new c(function(t){t(e.value)}).then(n,r)}o((a=a.apply(i,s||[])).next())})}function s(n,r){var o,i,s,t,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,i&&(s=2&e[0]?i.return:e[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,e[1])).done)return s;switch(i=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return c.label++,{value:e[1],done:!1};case 5:c.label++,i=e[1],e=[0];continue;case 7:e=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){c=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){c.label=e[1];break}if(6===e[0]&&c.label<s[1]){c.label=s[1],s=e;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(e);break}s[2]&&c.ops.pop(),c.trys.pop();continue}e=r.call(n,c)}catch(t){e=[6,t],i=0}finally{o=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}var c,t,e=function(){function t(){this.on=this.addEventListener,this.off=this.removeEventListener,this.events={}}return t.prototype.addEventListener=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];this.events[t]?this.events[t].push({target:e.target||e,handler:e,args:n}):this.events[t]=[{target:e.target||e,handler:e,args:n}]},t.prototype.removeEventListener=function(t,e){this.events[t]&&(this.events[t]=this.events[t].filter(function(t){return t.target!==e}))},t.prototype.removeAllListeners=function(t){void 0!==t?this.events[t]&&(this.events[t]=[]):this.events={}},t.prototype.once=function(t,e){for(var n,r,o,i,s,c=[],a=2;a<arguments.length;a++)c[a-2]=arguments[a];this.addEventListener.apply(this,[t,(n=this,r=t,o=e,i=!1,s=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];i||(n.removeEventListener(r,s),i=!0,o.apply(n,t))},s.target=o,s)].concat(c))},t.prototype.emit=function(t){for(var o=this,i=[],e=1;e<arguments.length;e++)i[e-1]=arguments[e];this.events[t]&&this.events[t].forEach(function(t){var e,n,r;e=t.handler,n=o,r=(t.args||[]).concat(i),Function.prototype.apply.call(e,n,r)})},t}();(t=c||(c={}))[t.CONNECTING=0]="CONNECTING",t[t.OPEN=1]="OPEN",t[t.CLOSING=2]="CLOSING",t[t.CLOSED=3]="CLOSED";var n,a,u,h,f,l=function(r){function t(t,e){var n=r.call(this)||this;return n.CLOSED=c.CLOSED,n.CLOSING=c.CLOSING,n.CONNECTING=c.CONNECTING,n.OPEN=c.OPEN,n.url=t,e&&(n.protocols=Array.isArray(e)?e:[e]),n.init(),n}return o(t,r),t}(e),p=function(t){return"error"===t?["%c 【PushSDK: "+t+"】\n","color:red;"]:["%c 【PushSDK: "+t+"】","color:#06c1ae;"]},d=function(){},v={info:(n=console.log).bind.apply(n,[console].concat(p("info"))),error:(a=console.error).bind.apply(a,[console].concat(p("error"))),warn:(u=console.warn).bind.apply(u,[console].concat(p("warn")))},y={info:d,error:d,warn:d},E={debug:function(t){var e=t?v:y;Object.assign(E,e)},info:d,error:d,warn:d},g=["wss://wpush.meituan.com","wss://bj-wpush.waimai.meituan.com","wss://sh-wpush.waimai.meituan.com"],C={prod:function(t,e){return E.info("获取动态域名参数，是否使用容灾：",t.useStandby,"，重连次数：",e),t.useStandby&&g[e%g.length]||g[0]},stage:"wss://wpush.waimai.st.meituan.com",test:"ws://wpush.waimai.test.meituan.com",develop:"ws://wpush.waimai.dev.sankuai.com",dev:"ws://wpush.waimai.dev.sankuai.com"},w={appKey:void 0,pushToken:void 0,env:"prod",debug:!1},m=function(t){return"~#HHHBBB#~"+t},O=function(t){function e(){var n=null!==t&&t.apply(this,arguments)||this;return n._readyState=c.CLOSED,n.isDestroy=!1,n.handleOpen=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];n.readyState=c.OPEN,n.fire.apply(n,["open"].concat(t))},n.handleClose=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];n.readyState=c.CLOSED,n.fire.apply(n,["close"].concat(t))},n.handleError=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];E.error.apply(E,["JS"].concat(t)),n.fire.apply(n,["error"].concat(t))},n.handleMessage=function(t){n.fire("message",t.data)},n}return o(e,t),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._readyState},set:function(t){this.emit("state",t),this._readyState=t},enumerable:!0,configurable:!0}),e.prototype.close=function(e,n){return i(this,void 0,void 0,function(){return s(this,function(t){return this.readyState!==c.OPEN?[2,Promise.reject(new Error("当前连接未建立"))]:(E.info("JS","close"),[2,this.ws.close(e,n)])})})},e.prototype.send=function(e){return i(this,void 0,void 0,function(){return s(this,function(t){return this.readyState!==c.OPEN?[2,Promise.reject(new Error("当前连接未建立"))]:(E.info("JS","send"),[2,this.ws.send(e)])})})},e.prototype.destroy=function(){return i(this,void 0,void 0,function(){return s(this,function(t){switch(t.label){case 0:return this.isDestroy=!0,[4,this.close()];case 1:return t.sent(),this.removeAllListeners(),[2]}})})},e.prototype.init=function(){return i(this,void 0,void 0,function(){var n=this;return s(this,function(t){return E.info("JS","init"),this.ws=new WebSocket(this.url),this.ws.addEventListener("open",function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return n.handleOpen.apply(n,t)}),this.ws.addEventListener("close",function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return n.handleClose.apply(n,t)}),this.ws.addEventListener("error",function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return n.handleError.apply(n,t)}),this.ws.addEventListener("message",function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return n.handleMessage.apply(n,t)}),this.readyState=c.CONNECTING,this.ws.readyState===c.CLOSED&&(this.readyState=c.CLOSED,this.fire("close")),[2]})})},e.prototype.fire=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.isDestroy||this.emit.apply(this,[t].concat(e))},e}(l);return h=O,(f=function(n){function t(t){var e=n.call(this)||this;return e.HEART_BEAT_DURATION=1e4,e.HEART_BEAT_BREAK_MAX_COUNT=10,e.RETRY_CONNECT_DURATION=1e4,e.retryConnectCount=0,e.retryConnectTimerId=null,e.onClose=function(){return i(e,void 0,void 0,function(){var e,n,r=this;return s(this,function(t){switch(t.label){case 0:return[4,this.close()];case 1:return t.sent(),e=Math.pow(2,this.retryConnectCount)*this.RETRY_CONNECT_DURATION,n=this.retryConnectCount+1,E.info("断开连接，准备开始重连，重连次数"+n+"，等待"+e/1e3+"秒",Date.now()),this.retryConnectTimerId=setTimeout(function(){E.info("开始重连，重连次数"+n,Date.now()),r.retryConnectCount=n,r.reconnect()},e),[2]}})})},e.onOpen=function(){return i(e,void 0,void 0,function(){return s(this,function(t){return E.info("连接成功，重连次数"+this.retryConnectCount),clearTimeout(this.retryConnectTimerId),this.retryConnectCount=0,this.startHeartBeat(),[2]})})},e.config=Object.assign({},w,t),E.debug(e.config.debug),e.HEART_BEAT_DURATION=e.config.heartBeatDuration||e.HEART_BEAT_DURATION,e.RETRY_CONNECT_DURATION=e.config.retryConnectDuration||e.RETRY_CONNECT_DURATION,e}return o(t,n),Object.defineProperty(t.prototype,"readyState",{get:function(){return this.socket?this.socket.readyState:c.CLOSED},enumerable:!0,configurable:!0}),t.prototype.send=function(t){return this.socket.send(t)},t.prototype.close=function(){return i(this,void 0,void 0,function(){return s(this,function(t){switch(t.label){case 0:return this.stopHeartBeat(),this.removeEventListener("close",this.onClose),this.removeEventListener("open",this.onOpen),this.removeAllListeners("hb"),this.socket?this.readyState===c.CLOSED?[3,2]:[4,this.socket.close()]:[3,3];case 1:t.sent(),t.label=2;case 2:this.socket.removeAllListeners(),this.socket=null,t.label=3;case 3:return[2]}})})},t.prototype.reconnect=function(){return i(this,void 0,void 0,function(){return s(this,function(t){switch(t.label){case 0:return[4,this.close()];case 1:return t.sent(),[4,this.connect()];case 2:return t.sent(),[2]}})})},t.prototype.connect=function(){return i(this,void 0,void 0,function(){return s(this,function(t){return this.socket?E.error("连接已存在，请使用reconnect进行重连"):(this.url=this.getConnectUrl(),E.info("开始建立连接，此次连接地址: "+this.url),this.socket=new h(this.url),this.useEventFilter(),this.once("close",this.onClose),this.once("open",this.onOpen)),[2]})})},t.prototype.startHeartBeat=function(){var t=this;this.stopHeartBeat();var e=1/0;E.info("开始心跳轮询"),this.socket.send(m(this.config.pushToken)),this.HBTimerId=setInterval(function(){return i(t,void 0,void 0,function(){return s(this,function(t){switch(t.label){case 0:return+new Date-e>this.HEART_BEAT_BREAK_MAX_COUNT*this.HEART_BEAT_DURATION?[4,this.close()]:[3,2];case 1:return t.sent(),E.info("心跳超时，主动断开连接，断开后会自动重连"),[2];case 2:return E.info("send HB",m(this.config.pushToken)),this.socket.send(m(this.config.pushToken)),[2]}})})},this.HEART_BEAT_DURATION),this.on("hb",function(){E.info("receive HB"),e=+new Date})},t.prototype.stopHeartBeat=function(){clearInterval(this.HBTimerId),this.HBTimerId=null},t.prototype.useEventFilter=function(){var n=this;this.socket.removeAllListeners(),this.socket.on("message",function(t){"HB"===t?n.emit("hb"):n.emit("message",t)}),this.socket.on("open",function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return n.emit.apply(n,["open"].concat(t))}),this.socket.on("close",function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return n.emit.apply(n,["close"].concat(t))}),this.socket.on("error",function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return n.emit.apply(n,["error"].concat(t))}),this.socket.on("state",function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return n.emit.apply(n,["state"].concat(t))})},t.prototype.getConnectUrl=function(){var t=this.config,e=t.env,n=t.pushToken,r=t.appKey;return("function"==typeof e?e(this.config,this.retryConnectCount):"function"==typeof C[e]?C[e](this.config,this.retryConnectCount):C[e]||e)+"/websocket/"+r+"/"+n},t}(e)).Socket=h,f.config=function(t){Object.assign(w,t)},f});
